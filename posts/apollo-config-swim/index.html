<!DOCTYPE html>
<html prefix="        og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="zh_cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Apollo 配置中心畅游 | I'm company</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="zh_cn" href="../../rss.xml">
<link rel="canonical" href="http://blog.imcompany.cn/posts/apollo-config-swim/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Tomyli">
<link rel="prev" href="../centos7-install-issue-collect/" title="Centos7 install issue collect" type="text/html">
<meta property="og:site_name" content="I'm company">
<meta property="og:title" content="Apollo 配置中心畅游">
<meta property="og:url" content="http://blog.imcompany.cn/posts/apollo-config-swim/">
<meta property="og:description" content="目前市面上的开源产品



Disconf


2014年7月百度开源的配置管理中心，同样具备配置的管理能力，目前已经不维护了，最近的一次代码提交是两年前了。




Spring Cloud Config


2014年9月开源，Spring Cloud生态组件，与Spring Cloud体系无缝整合。




Apollo


2016年5月，携程框架部开源的配置管理中心，具备规范的权限、流程">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-05-09T17:34:09+08:00">
</head>
<body>
    <a href="#page-content" class="sr-only sr-only-focusable">跳到主内容</a>
    <section class="social"><ul>
<li><a href="../../index.html" title="Home"><i class="fa fa-home"></i></a></li>
            <li><a href="../../archive.html" title="Archives"><i class="fa fa-folder-open"></i></a></li>
            <li><a href="../../categories/index.html" title="Tags"><i class="fa fa-tags"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="fa fa-rss"></i></a></li>
            <li><a href="https://about.me/tomyli" title="About me"><i class="fa fa-user"></i></a></li>
            <li><a href="https://twitter.com/hougemeiga" title="My Twitter"><i class="fab fa-twitter"></i></a></li>
            <li><a href="https://github.com/peng051410" title="My Github"><i class="fab fa-github"></i></a></li>
    
    

        </ul></section><section class="page-content"><div class="content" rel="main">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Apollo 配置中心畅游</a></h1>

        <div class="metadata">
            <p class="dateline"><a href="." rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2019-05-09T17:34:09+08:00" itemprop="datePublished" title="2019-05-09 17:34">2019-05-09 17:34</time></a></p>
            <p class="byline author vcard"> <i class="fa fa-user"></i> <span class="byline-name fn" itemprop="author">
                    Tomyli
            </span></p>
                <p class="commentline"><i class="far fa-comment"></i>
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/apollo-config-swim.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.org" class="sourcelink"><i class="fa fa-file-code"></i> 资源</a></p>

            

            

        </div>
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="outline-container-orgac1551b" class="outline-2">
<h2 id="orgac1551b">
<a id="ID-24469E90-D66B-46C3-8111-273DC545ED9C"></a>目前市面上的开源产品</h2>
<div class="outline-text-2" id="text-orgac1551b">
</div>
<div id="outline-container-org8de0e76" class="outline-3">
<h3 id="org8de0e76">
<a id="ID-A8F19C10-24A4-462A-A278-3CC6866B6104"></a><a href="https://github.com/knightliao/disconf">Disconf</a>
</h3>
<div class="outline-text-3" id="text-org8de0e76">
<p>
2014年7月百度开源的配置管理中心，同样具备配置的管理能力，目前已经不维护了，最近的一次代码提交是两年前了。
</p>
</div>
</div>
<div id="outline-container-org631d33c" class="outline-3">
<h3 id="org631d33c">
<a id="ID-A1015FF2-133D-4C64-BFB3-8A9E027D1D19"></a><a href="https://github.com/spring-cloud/spring-cloud-config">Spring Cloud Config</a>
</h3>
<div class="outline-text-3" id="text-org631d33c">
<p>
2014年9月开源，Spring Cloud生态组件，与Spring Cloud体系无缝整合。
</p>
</div>
</div>
<div id="outline-container-org3033baa" class="outline-3">
<h3 id="org3033baa">
<a id="ID-09F80DD2-2794-40E6-A443-2F4868166899"></a><a href="https://github.com/ctripcorp/apollo">Apollo</a>
</h3>
<div class="outline-text-3" id="text-org3033baa">
<p>
2016年5月，携程框架部开源的配置管理中心，具备规范的权限、流程治理等特性。
</p>
</div>
</div>
<div id="outline-container-org2432e85" class="outline-3">
<h3 id="org2432e85">
<a id="ID-A38D7032-C1A2-4C94-A771-E23ACE4B13F4"></a><a href="https://github.com/alibaba/nacos">Nacos</a>
</h3>
<div class="outline-text-3" id="text-org2432e85">
<p>
2018年6月，阿里开源的配置中心，可以做DNS和RPC的服务发现。
</p>
</div>
</div>
</div>
<div id="outline-container-org4c9909e" class="outline-2">
<h2 id="org4c9909e">
<a id="ID-93AD45B7-443A-4A92-8F7F-DBE208D9D995"></a>为什么选择Apollo</h2>
<div class="outline-text-2" id="text-org4c9909e">
</div>
<div id="outline-container-orgc0c23a1" class="outline-3">
<h3 id="orgc0c23a1">
<a id="ID-8B50A2C7-E400-4B1C-8C89-1E0FAD78C732"></a>社区活跃</h3>
<div class="outline-text-3" id="text-orgc0c23a1">
<p>
刚刚发布了<a href="https://github.com/ctripcorp/apollo/releases/tag/v1.4.0">1.4.0</a>版本，Issue处理速度快
</p>
</div>
</div>
<div id="outline-container-org367578d" class="outline-3">
<h3 id="org367578d">
<a id="ID-1F051A4F-9F86-494A-BE3D-CBF0568D9B13"></a>文档齐全</h3>
<div class="outline-text-3" id="text-org367578d">
<p>
体验，部署，设计文档都齐全
</p>
</div>
</div>
<div id="outline-container-orgf020c41" class="outline-3">
<h3 id="orgf020c41">
<a id="ID-3D3ED757-D257-4CC3-84B8-0752F4ACD983"></a>重要的灰度发布</h3>
<div class="outline-text-3" id="text-orgf020c41">
<p>
想发布一台机器试试水，可以！
</p>
</div>
</div>
<div id="outline-container-org1a1221d" class="outline-3">
<h3 id="org1a1221d">
<a id="ID-7A92103D-AFF4-4204-A8FC-CC0464E298D4"></a>开源协议友好</h3>
<div class="outline-text-3" id="text-org1a1221d">
<p>
Apache 2 license
</p>
<!-- TEASER_END -->
</div>
</div>
</div>
<div id="outline-container-org9a8692c" class="outline-2">
<h2 id="org9a8692c">
<a id="ID-0C1321E8-8D2E-495E-A1BB-65AC031794B3"></a>Apollo都有哪些重要功能</h2>
<div class="outline-text-2" id="text-org9a8692c">
<p>
以下摘自<a href="https://github.com/ctripcorp/apollo#features">官网说明</a>
</p>
</div>
<div id="outline-container-orge51529d" class="outline-3">
<h3 id="orge51529d">
<a id="ID-1643865B-0EF0-402F-B47E-0E21099A8FAC"></a>统一管理不同环境、不同集群的配置</h3>
<div class="outline-text-3" id="text-orge51529d">
</div>
</div>
<div id="outline-container-orgb629d79" class="outline-3">
<h3 id="orgb629d79">
<a id="ID-B7E2092D-B527-4592-A087-C74EAC86377C"></a>配置修改实时生效（热发布）</h3>
<div class="outline-text-3" id="text-orgb629d79">
</div>
</div>
<div id="outline-container-orgba69bfd" class="outline-3">
<h3 id="orgba69bfd">
<a id="ID-90C41B7F-0B4B-4DB8-9CF2-02828BDA6DE0"></a>版本发布管理</h3>
<div class="outline-text-3" id="text-orgba69bfd">
<p>
目前只支持对最近版本的恢复。<a href="https://github.com/ctripcorp/apollo/issues/1642">https://github.com/ctripcorp/apollo/issues/1642</a>
</p>
</div>
</div>
<div id="outline-container-org28a30dc" class="outline-3">
<h3 id="org28a30dc">
<a id="ID-BAEB34A8-6C80-4BFB-8CBC-41572072A260"></a>灰度发布</h3>
<div class="outline-text-3" id="text-org28a30dc">
</div>
</div>
<div id="outline-container-orgc99768d" class="outline-3">
<h3 id="orgc99768d">
<a id="ID-892929BB-D7E2-41B2-B198-D0C6F6C3B0A8"></a>权限管理、发布审核、操作审计</h3>
<div class="outline-text-3" id="text-orgc99768d">
<p>
编辑与发布是两个独立的操作。
</p>
</div>
</div>
<div id="outline-container-org600d41e" class="outline-3">
<h3 id="org600d41e">
<a id="ID-0227ED14-7754-4EF9-9579-11615DDB0609"></a>客户端配置信息监控</h3>
<div class="outline-text-3" id="text-org600d41e">
</div>
</div>
<div id="outline-container-org7596087" class="outline-3">
<h3 id="org7596087">
<a id="ID-35EE8191-FF3C-4778-8BFA-4AF5444B9048"></a>提供Java和.Net原生客户端</h3>
<div class="outline-text-3" id="text-org7596087">
</div>
</div>
<div id="outline-container-org335d9c6" class="outline-3">
<h3 id="org335d9c6">
<a id="ID-DECAE90E-1C80-44FD-B2C2-0B62A54E50FB"></a>提供开放平台API</h3>
<div class="outline-text-3" id="text-org335d9c6">
<p>
这样可以通过其它方式来查看配置信息，<a href="https://github.com/ctripcorp/apollo/wiki/Apollo%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0">平台API说明</a>
</p>
</div>
</div>
<div id="outline-container-org7cf1f1c" class="outline-3">
<h3 id="org7cf1f1c">
<a id="ID-0D846262-4FC3-4ED7-9BD6-8DF85489F13C"></a>使用方便的后台配置系统Portal</h3>
<div class="outline-text-3" id="text-org7cf1f1c">
</div>
</div>
<div id="outline-container-org2b298e9" class="outline-3">
<h3 id="org2b298e9">
<a id="ID-242AAC61-471F-47DB-A4F5-08372C963A92"></a>分布式部署相对较复杂，这是缺点</h3>
<div class="outline-text-3" id="text-org2b298e9">
<p>
外部依赖少，目前依赖Mysql
</p>
</div>
</div>
</div>
<div id="outline-container-org3d1927e" class="outline-2">
<h2 id="org3d1927e">
<a id="ID-AC32230B-1CCE-4CFC-806F-6F8FE3A70783"></a>Apollo的组成</h2>
<div class="outline-text-2" id="text-org3d1927e">
</div>
<div id="outline-container-org1b99c4a" class="outline-3">
<h3 id="org1b99c4a">
<a id="ID-920AD4AB-F81D-4BF4-A696-4C7F730AE8B3"></a>Apollo长什么样?</h3>
<div class="outline-text-3" id="text-org1b99c4a">
<p>
<img src="../../images/apollo-home-screenshot.png" alt="nil"></p>
</div>
</div>
<div id="outline-container-org9ef2bca" class="outline-3">
<h3 id="org9ef2bca">
<a id="ID-62516B1E-749F-46F5-9713-A138EACCF95B"></a>Apollo整体设计</h3>
<div class="outline-text-3" id="text-org9ef2bca">
</div>
<div id="outline-container-org3b3c863" class="outline-4">
<h4 id="org3b3c863">
<a id="ID-11B14E61-02E5-4828-B3D9-9E67B7D69D9D"></a>总体架构</h4>
<div class="outline-text-4" id="text-org3b3c863">
<p>
<img src="../../images/overall-architecture.png" alt="nil"></p>
</div>
</div>
<div id="outline-container-org3cb93b4" class="outline-4">
<h4 id="org3cb93b4">
<a id="ID-D757F06D-B9D8-4FB9-A452-A763E5F84F1F"></a>代码结构</h4>
<div class="outline-text-4" id="text-org3cb93b4">
<p>
<img src="../../images/apollo-code-structure.png" alt="nil"></p>

<p>
<a href="https://github.com/ctripcorp/apollo/wiki/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1#13-%E5%90%84%E6%A8%A1%E5%9D%97%E6%A6%82%E8%A6%81%E4%BB%8B%E7%BB%8D">各模块概要介绍</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org137d422" class="outline-3">
<h3 id="org137d422">
<a id="ID-EFC7B929-48E3-430E-B9D6-DDF4BB67A0A0"></a>Apollo Config Service</h3>
<div class="outline-text-3" id="text-org137d422">
<p>
提供配置获取接口，服务对象为Apollo客户端
</p>
</div>
</div>
<div id="outline-container-orged5b849" class="outline-3">
<h3 id="orged5b849">
<a id="ID-62CDB9D8-D64A-43D6-9768-900A1CDA9DCD"></a>Apollo Admin Service</h3>
<div class="outline-text-3" id="text-orged5b849">
<p>
提供配置管理（修改、发布）接口，服务与Portal
</p>
</div>
</div>
<div id="outline-container-org56aa2b5" class="outline-3">
<h3 id="org56aa2b5">
<a id="ID-C54CBBC7-88AF-4A4C-A4A5-00FF7C8F3A40"></a>Apollo Portal</h3>
<div class="outline-text-3" id="text-org56aa2b5">
<p>
提供WEB界面供用户管理配置
</p>
</div>
</div>
</div>
<div id="outline-container-org846ac45" class="outline-2">
<h2 id="org846ac45">
<a id="ID-2ECAA60E-CDEC-4156-9FFC-04A2875B3C1E"></a>Apollo的重要设计</h2>
<div class="outline-text-2" id="text-org846ac45">
</div>
<div id="outline-container-org0d76d00" class="outline-3">
<h3 id="org0d76d00">
<a id="ID-90F032EB-378F-4447-A244-0E4B9321C0F4"></a>Admin Service与Config Service的通信方式</h3>
<div class="outline-text-3" id="text-org0d76d00">
<p>
Apollo使用Mysql实现消息(ReleaseMessage)的处理，消息内容为AppId+Cluster+Namespace
</p>

<p>
<img src="../../images/release-message-design.png" alt="nil"></p>

<p>
具体的设计思想可以参考<a href="https://github.com/ctripcorp/apollo/wiki/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1#211-%E5%8F%91%E9%80%81releasemessage%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">这里</a>
</p>
</div>
</div>
<div id="outline-container-orgfbf5a2a" class="outline-3">
<h3 id="orgfbf5a2a">
<a id="ID-BE21C115-40BE-4E4C-BC83-E444B7BEACE6"></a>客户端与服务端的通信方式</h3>
<div class="outline-text-3" id="text-orgfbf5a2a">
<p>
客户端与服务端保持一个长连接(通过Http Long Polling实现)
<a href="file:///Users/tomyli/github/apollo/doc/images/client-architecture.png">Client Server</a>
</p>
</div>
</div>
<div id="outline-container-orgf76c2a9" class="outline-3">
<h3 id="orgf76c2a9">
<a id="ID-D278B193-F25B-4C7F-A063-5C5DD2EA6041"></a>重要的Namespace</h3>
<div class="outline-text-3" id="text-orgf76c2a9">
<p>
Namespace是配置项的集合，类似于一个配置文件的概念，获取的权限分为private与public两种权限。
</p>
</div>
<div id="outline-container-org363f42b" class="outline-4">
<h4 id="org363f42b">
<a id="ID-80D21C9D-25F8-48E8-A629-753757697AD9"></a>Namespace的类型</h4>
<div class="outline-text-4" id="text-org363f42b">
<ul class="org-ul">
<li>私有类型</li>
<li>公有类型</li>
<li>关联类型（继承类型）</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org16866c6" class="outline-3">
<h3 id="org16866c6">
<a id="ID-7999356A-1E22-424D-A577-81EE1EECCA14"></a>Cluster能用来做什么?</h3>
<div class="outline-text-3" id="text-org16866c6">
<p>
分机房实例，分任务功能实例，比如在一些实例执行job，需要增加-Dapollo.cluster=配置指定集群名
</p>
</div>
</div>
</div>
<div id="outline-container-org19e52a9" class="outline-2">
<h2 id="org19e52a9">
<a id="ID-9BA86A7E-AD18-4162-BFA6-8C04AE88AD9C"></a>体验部署方式</h2>
<div class="outline-text-2" id="text-org19e52a9">
<p>
Docker，本地源代码，虚拟机多环境
</p>
</div>
</div>
<div id="outline-container-orgf6bdabb" class="outline-2">
<h2 id="orgf6bdabb">
<a id="ID-CED3F392-CA50-497B-8253-971664F19DBF"></a>使用注意事项</h2>
<div class="outline-text-2" id="text-orgf6bdabb">
<ul class="org-ul">
<li>在主版本有未发布的配置项时，要发布灰度后的全量则需要先把主版本中的配置发布后方可操作</li>
<li>使用docker运行demo测试时连接不上docker中的服务解决方法：<a href="https://github.com/ctripcorp/apollo/issues/1481#issuecomment-422057411w">https://github.com/ctripcorp/apollo/issues/1481#issuecomment-422057411w</a>
</li>
<li>/opt目录要有读写权限，日志文件默认打印在此目录</li>
<li>Client端要使用本地缓存配置，默认情况下确保/opt/data目录存在</li>
<li>线上环境配置建议配置在机器上，不建议配置在代码中，与代码解耦</li>
<li>config与admin service要开放端口8080与8090(默认情况下)，端口可以在项目中的starup.sh中修改</li>
<li>如果Config Service配置开启了内存缓存数据(config-service.cache.enabled)，要提前考虑数据量的大小，调整服务的内存配置</li>
<li>在配置单环境(如开发环境)高可用时配置修改点
<ul class="org-ul">
<li>修改config库的eureka.service.url配置项为多个开发环境的meta server地址</li>
<li>修改portal的apollo-env.properties文件中的开发环境指定地址</li>
<li>修改admin与config的连接数据库地址，都连接到开发环境的mysql地址</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org7fb723c" class="outline-2">
<h2 id="org7fb723c">
<a id="ID-8D01547C-7A70-4520-9E93-4820385D31CD"></a>参考文档</h2>
<div class="outline-text-2" id="text-org7fb723c">
<blockquote>
<p>
<a href="https://github.com/ctripcorp/apollo">https://github.com/ctripcorp/apollo</a>
</p>

<p>
<a href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a> 
</p>

<p>
<a href="http://dockone.io/article/8767">http://dockone.io/article/8767</a>
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org05d8a8b" class="outline-2">
<h2 id="org05d8a8b">
<a id="ID-F209BF01-70B7-4A5E-9595-ABD967F6443B"></a>后续待确认问题</h2>
<div class="outline-text-2" id="text-org05d8a8b">
</div>
<div id="outline-container-org508d258" class="outline-3">
<h3 id="org508d258">
<a id="ID-E8AE81D5-3406-45CB-B35D-8D24A086B1BF"></a>客户端的读取权限</h3>
<div class="outline-text-3" id="text-org508d258">
</div>
</div>
<div id="outline-container-org531e78d" class="outline-3">
<h3 id="org531e78d">
<a id="ID-A48102F1-F9D7-45E9-8951-1126E198283D"></a>docker的实例获取问题</h3>
<div class="outline-text-3" id="text-org531e78d">
</div>
</div>
<div id="outline-container-orge48f3d6" class="outline-3">
<h3 id="orge48f3d6">
<a id="ID-EFF9C14D-4F0D-4EDC-9B09-307B929C39DD"></a>本地调试读取配置问题</h3>
<div class="outline-text-3" id="text-orge48f3d6">
</div>
</div>
<div id="outline-container-orgea20d9e" class="outline-3">
<h3 id="orgea20d9e">
<a id="ID-31E808C3-330E-40C4-AE82-CE97F541094C"></a>Client怎么来修改配置</h3>
<div class="outline-text-3" id="text-orgea20d9e">
</div>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../centos7-install-issue-collect/" rel="prev" title="Centos7 install issue collect">上一篇文章</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>评论</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="tomyli",
            disqus_url="http://blog.imcompany.cn/posts/apollo-config-swim/",
        disqus_title="Apollo \u914d\u7f6e\u4e2d\u5fc3\u7545\u6e38",
        disqus_identifier="cache/posts/apollo-config-swim.html",
        disqus_config = function () {
            this.language = "zh_cn";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="tomyli";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2019         <a href="mailto:peng051410@gmail.comjoe@demo.site">Tomyli</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("zh-cn");
    fancydates(2, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
